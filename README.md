# åŠ¨æ€é™æµå™¨ (Dynamic Rate Limiter)

ä¸€ä¸ªåŸºäºGoè¯­è¨€å®ç°çš„æ™ºèƒ½åŠ¨æ€é™æµç³»ç»Ÿï¼Œèƒ½å¤Ÿæ ¹æ®ç³»ç»Ÿè´Ÿè½½å®æ—¶è°ƒæ•´é™æµå‚æ•°ï¼Œç¡®ä¿æœåŠ¡ç¨³å®šæ€§å’Œæœ€ä¼˜æ€§èƒ½ã€‚

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

### æ™ºèƒ½è‡ªé€‚åº”ç®—æ³•
- **å¤šç»´åº¦ç›‘æ§**: CPUä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨ç‡ã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡
- **åŠ æƒè¯„åˆ†ç³»ç»Ÿ**: å„æŒ‡æ ‡æŒ‰æƒé‡è®¡ç®—æ€»è´Ÿè½½ (CPU 30%, å†…å­˜ 20%, å“åº”æ—¶é—´ 30%, é”™è¯¯ç‡ 20%)
- **åŠ¨æ€è°ƒæ•´**: æ ¹æ®è´Ÿè½½æƒé‡å®æ—¶è°ƒæ•´é™æµé˜ˆå€¼
- **å¹³æ»‘è¿‡æ¸¡**: é¿å…é™æµå€¼å‰§çƒˆæ³¢åŠ¨

### å¤šç§é™æµç­–ç•¥
- **ä»¤ç‰Œæ¡¶ç®—æ³•**: æ”¯æŒçªå‘æµé‡ï¼Œå¹³æ»‘é™æµ
- **æ»‘åŠ¨çª—å£**: ç²¾ç¡®æ§åˆ¶æ—¶é—´çª—å£å†…çš„è¯·æ±‚æ•°é‡
- **è‡ªé€‚åº”åˆ‡æ¢**: æ ¹æ®åœºæ™¯è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç­–ç•¥

### ä¼ä¸šçº§åŠŸèƒ½
- **é…ç½®ç®¡ç†**: JSONé…ç½®æ–‡ä»¶ï¼Œæ”¯æŒçƒ­é‡è½½
- **æŒ‡æ ‡ç›‘æ§**: Prometheusæ ¼å¼æŒ‡æ ‡å¯¼å‡º
- **æ€§èƒ½åˆ†æ**: è¯¦ç»†çš„æ€§èƒ½æ•°æ®æ”¶é›†å’Œåˆ†æ
- **å¥åº·æ£€æŸ¥**: HTTPå¥åº·æ£€æŸ¥ç«¯ç‚¹
- **ä¼˜é›…åœæœº**: æ”¯æŒä¿¡å·å¤„ç†å’Œä¼˜é›…å…³é—­

## ğŸ“ é¡¹ç›®ç»“æ„

```
limitrate/
â”œâ”€â”€ main.go              # åŸå§‹å®ç°
â”œâ”€â”€ enhanced_main.go     # å¢å¼ºç‰ˆä¸»ç¨‹åº
â”œâ”€â”€ rate_limiter.go      # é™æµå™¨å®ç°
â”œâ”€â”€ system_monitor.go    # ç³»ç»Ÿç›‘æ§ç»„ä»¶
â”œâ”€â”€ config.go           # é…ç½®ç®¡ç†
â”œâ”€â”€ metrics.go          # æŒ‡æ ‡æ”¶é›†å’Œå¯¼å‡º
â”œâ”€â”€ go.mod              # Goæ¨¡å—æ–‡ä»¶
â””â”€â”€ README.md           # é¡¹ç›®æ–‡æ¡£
```

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Go 1.22.3+
- æ“ä½œç³»ç»Ÿ: Windows/Linux/macOS

### å®‰è£…å’Œè¿è¡Œ

1. **å…‹éš†é¡¹ç›®**
```bash
git clone <repository-url>
cd limitrate
```

2. **è¿è¡ŒåŸå§‹ç‰ˆæœ¬**
```bash
go run main.go
```

3. **è¿è¡Œå¢å¼ºç‰ˆæœ¬**
```bash
go run enhanced_main.go rate_limiter.go system_monitor.go config.go metrics.go
```

4. **ä½¿ç”¨è‡ªå®šä¹‰é…ç½®**
```bash
go run enhanced_main.go rate_limiter.go system_monitor.go config.go metrics.go ./custom_config.json
```

### é…ç½®æ–‡ä»¶

ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶ `./config/config.json`:

```json
{
  "monitor": {
    "monitor_interval": "5s",
    "adjust_interval": "10s",
    "enable_cpu": true,
    "enable_memory": true,
    "enable_rt": true,
    "enable_error": true
  },
  "rate_limit": {
    "base_limit": 1000,
    "current_limit": 1000,
    "min_limit": 100,
    "max_limit": 5000,
    "adjust_factor": 1.0
  },
  "threshold": {
    "cpu_high": 70.0,
    "cpu_critical": 85.0,
    "mem_high": 80.0,
    "mem_critical": 90.0,
    "rt_high": 100.0,
    "rt_critical": 300.0,
    "error_high": 5.0,
    "error_critical": 10.0
  },
  "server": {
    "port": 8080,
    "host": "0.0.0.0",
    "read_timeout": "30s",
    "write_timeout": "30s",
    "enable_http": true,
    "enable_grpc": false
  },
  "metrics": {
    "enable_prometheus": true,
    "prometheus_port": 9090,
    "metrics_path": "/metrics",
    "enable_pprof": true,
    "pprof_port": 6060
  }
}
```

## ğŸ“Š ç›‘æ§å’ŒæŒ‡æ ‡

### HTTPç«¯ç‚¹

å¯åŠ¨åå¯è®¿é—®ä»¥ä¸‹ç«¯ç‚¹ï¼š

- **æŒ‡æ ‡æ•°æ®**: `http://localhost:9090/metrics` (Prometheusæ ¼å¼)
- **JSONæŒ‡æ ‡**: `http://localhost:9090/metrics?format=json`
- **å¥åº·æ£€æŸ¥**: `http://localhost:9090/health`
- **ç³»ç»ŸçŠ¶æ€**: `http://localhost:9090/status`

### å…³é”®æŒ‡æ ‡

- `cpu_usage_percent`: CPUä½¿ç”¨ç‡ç™¾åˆ†æ¯”
- `memory_usage_percent`: å†…å­˜ä½¿ç”¨ç‡ç™¾åˆ†æ¯”
- `goroutine_count`: Goroutineæ•°é‡
- `response_time_ms`: å¹³å‡å“åº”æ—¶é—´(æ¯«ç§’)
- `error_rate_percent`: é”™è¯¯ç‡ç™¾åˆ†æ¯”
- `rate_limit_current`: å½“å‰é™æµå€¼
- `token_bucket_tokens`: ä»¤ç‰Œæ¡¶å½“å‰ä»¤ç‰Œæ•°
- `token_bucket_capacity`: ä»¤ç‰Œæ¡¶å®¹é‡

## ğŸ”§ æ ¸å¿ƒç®—æ³•è¯¦è§£

### è´Ÿè½½æƒé‡è®¡ç®—

ç³»ç»Ÿä½¿ç”¨åŠ æƒè¯„åˆ†ç®—æ³•è®¡ç®—æ€»è´Ÿè½½ï¼š

```go
totalWeight = cpuWeight*0.3 + memWeight*0.2 + rtWeight*0.3 + errorWeight*0.2
```

### æƒé‡è®¡ç®—è§„åˆ™

å¯¹äºæ¯ä¸ªæŒ‡æ ‡ï¼š
- **æ­£å¸¸èŒƒå›´** (â‰¤ é«˜é˜ˆå€¼): æƒé‡ = 1.0
- **é«˜è´Ÿè½½èŒƒå›´** (é«˜é˜ˆå€¼ < å€¼ â‰¤ ä¸´ç•Œé˜ˆå€¼): æƒé‡çº¿æ€§é€’å‡ 1.0 â†’ 0.5
- **ä¸´ç•ŒèŒƒå›´** (> ä¸´ç•Œé˜ˆå€¼): æƒé‡ç»§ç»­é€’å‡ 0.5 â†’ 0.1

### é™æµå€¼è°ƒæ•´

```go
newLimit = baseLimit * loadWeight
```

é™æµå€¼è¢«çº¦æŸåœ¨ `[minLimit, maxLimit]` èŒƒå›´å†…ã€‚

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### WebæœåŠ¡ä¿æŠ¤
```go
// åœ¨HTTPå¤„ç†å™¨ä¸­ä½¿ç”¨
func handleRequest(w http.ResponseWriter, r *http.Request) {
    if !rateLimiter.AllowRequest() {
        http.Error(w, "Rate limit exceeded", http.StatusTooManyRequests)
        return
    }
    
    start := time.Now()
    // å¤„ç†è¯·æ±‚...
    duration := time.Since(start)
    
    rateLimiter.RecordEnhancedRequest(duration, false)
}
```

### APIç½‘å…³é›†æˆ
```go
// åˆ›å»ºå¢å¼ºé™æµå™¨
app, err := NewEnhancedRateLimiterApp("./config.json")
if err != nil {
    log.Fatal(err)
}

// å¯åŠ¨ç›‘æ§
app.Start()
defer app.Stop()

// åœ¨ä¸­é—´ä»¶ä¸­ä½¿ç”¨
func rateLimitMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        if app.monitor.AllowRequest() {
            next.ServeHTTP(w, r)
        } else {
            http.Error(w, "Rate limited", 429)
        }
    })
}
```

## ğŸ” æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. é…ç½®è°ƒä¼˜
- æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´ç›‘æ§é—´éš”
- è®¾ç½®åˆé€‚çš„é˜ˆå€¼å‚æ•°
- é€‰æ‹©é€‚åˆçš„é™æµç­–ç•¥

### 2. ç³»ç»Ÿç›‘æ§
- å®šæœŸæ£€æŸ¥æŒ‡æ ‡æ•°æ®
- ç›‘æ§é”™è¯¯ç‡å’Œå“åº”æ—¶é—´
- å…³æ³¨ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

### 3. å®¹é‡è§„åˆ’
- åŸºäºå†å²æ•°æ®è®¾ç½®åŸºç¡€é™æµå€¼
- é¢„ç•™è¶³å¤Ÿçš„ç¼“å†²ç©ºé—´
- è€ƒè™‘ä¸šåŠ¡å³°å€¼åœºæ™¯

## ğŸš§ æ‰©å±•åŠŸèƒ½

### åˆ†å¸ƒå¼æ”¯æŒ
å¯ä»¥æ‰©å±•æ”¯æŒRedisç­‰åˆ†å¸ƒå¼å­˜å‚¨ï¼š

```go
type DistributedRateLimiter struct {
    redis *redis.Client
    // ...
}
```

### è‡ªå®šä¹‰ç®—æ³•
æ”¯æŒæ’ä»¶åŒ–çš„é™æµç®—æ³•ï¼š

```go
type RateLimitAlgorithm interface {
    Allow(key string) bool
    UpdateLimit(limit int64)
}
```

### æ•°æ®æŒä¹…åŒ–
æ”¯æŒå°†æ€§èƒ½æ•°æ®æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼š

```go
func (app *App) SavePerformanceData() error {
    data, _ := app.ExportPerformanceData()
    return database.Save("performance", data)
}
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥**
   - æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œæƒé™
   - éªŒè¯JSONæ ¼å¼æ­£ç¡®æ€§

2. **æŒ‡æ ‡æœåŠ¡å™¨å¯åŠ¨å¤±è´¥**
   - æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
   - ç¡®è®¤é˜²ç«å¢™è®¾ç½®

3. **é™æµè¿‡äºä¸¥æ ¼**
   - è°ƒæ•´é˜ˆå€¼å‚æ•°
   - å¢åŠ æœ€å°é™æµå€¼

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š
```bash
export LOG_LEVEL=debug
go run enhanced_main.go ...
```

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

åœ¨æ ‡å‡†æµ‹è¯•ç¯å¢ƒä¸‹çš„æ€§èƒ½è¡¨ç°ï¼š

- **ååé‡**: 10,000+ QPS
- **å»¶è¿Ÿ**: P99 < 1ms
- **å†…å­˜å ç”¨**: < 50MB
- **CPUä½¿ç”¨ç‡**: < 5%

åŠŸèƒ½æ¨¡å—	åŸå§‹ç‰ˆæœ¬	å¢å¼ºç‰ˆæœ¬	æ”¹è¿›æ•ˆæœ
é™æµæ‰§è¡Œ	âŒ åªè®¡ç®—é™æµå€¼	âœ… Token Bucket + æ»‘åŠ¨çª—å£	çœŸæ­£æ‹¦æˆªè¯·æ±‚
CPUç›‘æ§	ğŸ”¶ ç®€å•ä¼°ç®—	âœ… æ”¹è¿›ç®—æ³• + æ³¢åŠ¨æ¨¡æ‹Ÿ	æ›´çœŸå®çš„CPUæ•°æ®
å“åº”æ—¶é—´	ğŸ”¶ ç®€å•å¹³å‡å€¼	âœ… ç™¾åˆ†ä½æ•°ç»Ÿè®¡	P50/P90/P95/P99
é”™è¯¯ç‡è·Ÿè¸ª	ğŸ”¶ ç´¯è®¡è®¡ç®—	âœ… æ»‘åŠ¨çª—å£	æ—¶é—´çª—å£å†…å‡†ç¡®ç‡
é…ç½®ç®¡ç†	âŒ ç¡¬ç¼–ç 	âœ… JSONé…ç½® + éªŒè¯	çµæ´»é…ç½® + çƒ­é‡è½½
æŒ‡æ ‡å¯¼å‡º	âŒ æ— 	âœ… Prometheus + HTTP	å¤–éƒ¨ç›‘æ§é›†æˆ
æ€§èƒ½åˆ†æ	âŒ æ— 	âœ… å†å²æ•°æ® + è¶‹åŠ¿	æ·±åº¦æ€§èƒ½æ´å¯Ÿ
åº”ç”¨æ¡†æ¶	ğŸ”¶ ç®€å•ç¤ºä¾‹	âœ… å®Œæ•´åº”ç”¨	ç”Ÿäº§çº§æ¶æ„

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           EnhancedRateLimiterApp        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ConfigManager   â”‚  HTTPMetricsServer    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ JSON Config â”‚ â”‚  â”‚ /metrics        â”‚  â”‚
â”‚ â”‚ Validation  â”‚ â”‚  â”‚ /status         â”‚  â”‚
â”‚ â”‚ Hot Reload  â”‚ â”‚  â”‚ /health         â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ EnhancedMonitor â”‚  MetricsCollector     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ TokenBucket â”‚ â”‚  â”‚ Prometheus      â”‚  â”‚
â”‚ â”‚ SlideWindow â”‚ â”‚  â”‚ Performance     â”‚  â”‚
â”‚ â”‚ CPU/Mem/RT  â”‚ â”‚  â”‚ Profiler        â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Forké¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. æ¨é€åˆ°åˆ†æ”¯
5. åˆ›å»ºPull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

## ğŸ”— ç›¸å…³èµ„æº

- [Goå®˜æ–¹æ–‡æ¡£](https://golang.org/doc/)
- [Prometheusç›‘æ§](https://prometheus.io/)
- [é™æµç®—æ³•è¯¦è§£](https://en.wikipedia.org/wiki/Rate_limiting)

---

**æ³¨æ„**: è¿™æ˜¯ä¸€ä¸ªå­¦ä¹ å’Œæ¼”ç¤ºé¡¹ç›®ï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰è¯·è¿›è¡Œå……åˆ†æµ‹è¯•å’Œä¼˜åŒ–ã€‚
